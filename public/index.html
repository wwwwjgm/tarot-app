<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8" />
    <title>ğŸ”® å‘½é‹ä¹‹é–€ å¡”ç¾…ç‰Œ</title>
    <link rel="stylesheet" href="/style.css" />
</head>

<body>
    <div class="app-container">
        <header>
            <h1>å¿å®å¡”ç¾…</h1>
            <p class="subtitle">ç•¶ä½ æº–å‚™å¥½é¢å°å‘½é‹ï¼Œç‰Œè‡ªç„¶æœƒå‡ºç¾ã€‚</p>
        </header>

        <main>
            <section class="config-panel">
                <label for="question">ä½ çš„å•é¡Œï¼š</label>
                <textarea id="question" rows="3" placeholder="ä¾‹å¦‚ï¼šæˆ‘æƒ³å•æœªä¾†ä¸€å¹´æ„Ÿæƒ…ç™¼å±•çš„æ–¹å‘ï¼Ÿ"></textarea>

                <div class="row">
                    <div class="field">
                        <label for="spreadType">ç‰Œé™£ï¼š</label>
                        <select id="spreadType">
                            <option value="1-single">å–®å¼µæŒ‡å¼•ï¼ˆ1 å¼µï¼‰</option>
                            <option value="3-ppf" selected>ä¸‰å¼µï¼šéå»ï¼ç¾åœ¨ï¼æœªä¾†ï¼ˆ3 å¼µï¼‰</option>
                            <option value="3-sba">ä¸‰å¼µï¼šç‹€æ…‹ï¼é˜»ç¤™ï¼å»ºè­°ï¼ˆ3 å¼µï¼‰</option>
                            <option value="5-general">äº”å¼µï¼šæƒ…å¢ƒåˆ†æï¼ˆ5 å¼µï¼‰</option>
                            <option value="5-story">äº”å¼µï¼šäº‹ä»¶èµ°å‘è§£æï¼ˆ5 å¼µï¼‰</option>
                            <option value="6-love">å…­å¼µï¼šæ„›æƒ…å…­èŠ’æ˜Ÿï¼ˆ6 å¼µï¼‰</option>
                            <option value="7-status">ä¸ƒå¼µï¼šç‹€æ…‹æª¢è¦–ï¼ˆ7 å¼µï¼‰</option>
                            <option value="10-celtic">åå¼µï¼šå‡±çˆ¾ç‰¹åå­—ï¼ˆ10 å¼µï¼‰</option>
                        </select>
                    </div>
                    <!-- æŠ½ç‰Œå¼µæ•¸ç”±ç‰Œé™£è‡ªå‹•æ±ºå®šï¼ŒåŸæœ¬çš„ cardCount ä¸‹æ‹‰é¸å–®å°±ä¸éœ€è¦äº† -->
                </div>

                <button id="drawBtn" class="tarot-button">
                    <img src="/images/tarot-button.jpg" alt="æŠ½ç‰Œä¸¦è§£è®€" />
                </button>
            </section>

            <section class="result-panel">
                <h2>æŠ½ç‰Œçµæœ</h2>
                <div id="cardsContainer" class="cards"></div>

                <h2>AI è§£è®€</h2>
                <div id="answer" class="answer"></div>
            </section>
        </main>

        <footer>
            <small>é™³å¿å®æ¶è¨­çš„å¡”ç¾…ç³»çµ± Â· åƒ…ä¾›æ€è€ƒåƒè€ƒï¼Œä¸ä½œç‚ºä»»ä½•å°ˆæ¥­æŠ•è³‡ï¼é†«ç™‚ï¼æ³•å¾‹å»ºè­°</small>
        </footer>
    </div>

    <script src="tarot-data.js"></script>
    <script>
        const drawBtn = document.getElementById("drawBtn");
        const cardsContainer = document.getElementById("cardsContainer");
        const answerEl = document.getElementById("answer");

        // æ ¹æ“šç‰Œé™£ key æ±ºå®šè¦æŠ½å¹¾å¼µç‰Œ & çµ¦å¾Œç«¯çœ‹çš„ä¸­æ–‡åç¨±
        function getSpreadConfig(spreadKey) {
            switch (spreadKey) {
                case "1-single":
                    return { cardCount: 1, label: "å–®å¼µæŒ‡å¼•" };
                case "3-ppf":
                    return { cardCount: 3, label: "ä¸‰å¼µï¼šéå»ï¼ç¾åœ¨ï¼æœªä¾†" };
                case "3-sba":
                    return { cardCount: 3, label: "ä¸‰å¼µï¼šç‹€æ…‹ï¼é˜»ç¤™ï¼å»ºè­°" };
                case "5-general":
                    return { cardCount: 5, label: "äº”å¼µï¼šæƒ…å¢ƒåˆ†æ" };
                case "5-story":
                    return { cardCount: 5, label: "äº”å¼µï¼šäº‹ä»¶èµ°å‘è§£æ" };
                case "6-love":
                    return { cardCount: 6, label: "å…­å¼µï¼šæ„›æƒ…å…­èŠ’æ˜Ÿ" };
                case "7-status":
                    return { cardCount: 7, label: "ä¸ƒå¼µï¼šç‹€æ…‹æª¢è¦–" };
                case "10-celtic":
                    return { cardCount: 10, label: "åå¼µï¼šå‡±çˆ¾ç‰¹åå­—" };
                default:
                    return { cardCount: 3, label: "ä¸‰å¼µç‰Œ" };
            }
        }

        function renderCards(cards) {
            cardsContainer.innerHTML = "";

            cards.forEach((c, index) => {
                const cardDiv = document.createElement("div");
                cardDiv.className = "card";

                cardDiv.innerHTML = `
      <div class="card-inner">
        <!-- æ­£é¢ï¼šç‰Œåï¼‹æ­£é€†ä½ -->
        <div class="card-face card-front">
          <div class="card-front-title">${c.cnName}</div>
          <div class="card-front-sub">
            ${c.arcana === "major" ? "å¤§é˜¿çˆ¾å…‹é‚£" : c.suit || ""}
          </div>
          <div class="card-front-orientation">${c.orientation}</div>
        </div>

        <!-- èƒŒé¢ï¼šä½ç½®ï¼‹é—œéµè© -->
        <div class="card-face card-back">
          <div class="card-pos">#${index + 1} Â· ${c.position}</div>
          <div class="card-back-name">${c.cnName}</div>
          <div class="card-back-meta">${c.name}</div>
          ${c.keywords && c.keywords.length
                        ? `<div class="card-back-keywords">é—œéµè©ï¼š${c.keywords.join("ã€")}</div>`
                        : ""
                    }
        </div>
      </div>
    `;

                // é»ç‰Œç¿»é¢
                cardDiv.addEventListener("click", () => {
                    cardDiv.classList.toggle("is-flipped");
                });

                cardsContainer.appendChild(cardDiv);
            });
        }


        async function callTarotAPI(question, spreadLabel, cards) {
            answerEl.textContent = "GPT æ­£åœ¨æ€è€ƒè§£è®€ä¸­â€¦";
            const res = await fetch("/api/tarot", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ question, spreadType: spreadLabel, cards }),
            });

            const data = await res.json();
            if (!data.ok) {
                answerEl.textContent = "è§£è®€å¤±æ•—ï¼š" + (data.error || "æœªçŸ¥éŒ¯èª¤");
                return;
            }
            answerEl.textContent = data.answer;
        }

        drawBtn.addEventListener("click", async () => {
            const question = document.getElementById("question").value.trim();
            const spreadKey = document.getElementById("spreadType").value;

            if (!question) {
                alert("è«‹å…ˆè¼¸å…¥ä½ çœŸæ­£æƒ³å•çš„å•é¡Œï¼ˆè¶Šå…·é«”è¶Šå¥½ï¼‰");
                return;
            }

            // ä¾ç…§ç‰Œé™£æ±ºå®šè¦æŠ½å¹¾å¼µ & çµ¦å¾Œç«¯çš„ä¸­æ–‡ç‰Œé™£åç¨±
            const { cardCount, label } = getSpreadConfig(spreadKey);

            // å¾ tarot-data.js æŠ½ç‰Œï¼ˆç¬¬äºŒå€‹åƒæ•¸è¦æ”¹æˆ spreadKeyï¼Œè·Ÿ assignPositions å°æ‡‰ï¼‰
            const cards = drawTarotCards(cardCount, spreadKey);

            renderCards(cards);
            // å¾Œç«¯æ¥åˆ°çš„æ˜¯æ¯”è¼ƒå¥½æ‡‚çš„ä¸­æ–‡åç¨±ï¼ˆlabelï¼‰
            await callTarotAPI(question, label, cards);
        });
    </script>
</body>

</html>